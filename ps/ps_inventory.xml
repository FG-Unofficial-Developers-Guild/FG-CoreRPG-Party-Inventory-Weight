<?xml version="1.0" encoding="iso-8859-1"?>

<!-- 
  Please see the LICENSE.md file included with this distribution for 
  attribution and copyright information.
-->

<root>
	<windowclass name="ps_inventory" merge="join">
		<script>
			local function calculateItemWeight(node_party_sheet)
				local node_party_items = node_party_sheet.getChild('treasureparcelitemlist')
				local number_weight_total = 0
				for _,node_party_item in pairs(node_party_items.getChildren()) do
					local number_item_count = DB.getValue(node_party_item, 'count', 0)
					local number_item_weight = DB.getValue(node_party_item, 'weight', 0)
					number_weight_total = number_weight_total + (number_item_count * number_item_weight) 
				end
				return number_weight_total
			end
			local function calculateCoinWeight(node_party_sheet)
				local node_party_coins = node_party_sheet.getChild('treasureparcelcoinlist')
				local number_coins_total = 0
				if CoinsWeight then
					for _,node_party_coin in pairs(node_party_coins.getChildren()) do
						local string_coin_description = DB.getValue(node_party_coin, 'description', ''):lower()
						if CoinsWeight.aDenominations[string_coin_description] then
							number_coins_total = number_coins_total + DB.getValue(node_party_coin, 'amount', 0) * CoinsWeight.aDenominations[string_coin_description]['nWeight']
						else
							number_coins_total = number_coins_total + DB.getValue(node_party_coin, 'amount', 0) * CoinsWeight.nDefaultCoinWeight
						end
					end
				end
				return number_coins_total
			end
			local function updateWeight()
				local node_party_sheet = getDatabaseNode()
				local number_item_weight = calculateItemWeight(node_party_sheet)
				local number_coin_weight = calculateCoinWeight(node_party_sheet)
				local number_total_weight = number_item_weight + number_coin_weight
				DB.setValue(node_party_sheet, 'partyinventoryweight', 'number', number_total_weight)
			end
			function onInit()
				if super and super.onInit then
					super.onInit()
				end
				if Session.IsHost then
					DB.addHandler("partysheet.treasureparcelcoinlist.*", "onChildUpdate", updateWeight)
					DB.addHandler("partysheet.treasureparcelitemlist.*.count", "onUpdate", updateWeight)
					DB.addHandler("partysheet.treasureparcelitemlist.*.weight", "onUpdate", updateWeight)
				end
				updateWeight()
			end
			function onClose()
				if super and super.onClose then
					super.onClose()
				end
				if Session.IsHost then
					DB.removeHandler("partysheet.treasureparcelcoinlist.*", "onChildUpdate", updateWeight)
					DB.removeHandler("partysheet.treasureparcelitemlist.*.count", "onUpdate", updateWeight)
					DB.removeHandler("partysheet.treasureparcelitemlist.*.weight", "onUpdate", updateWeight)
				end
			end
		</script>
		<sheetdata>
			<basicnumber name="partyinventoryweight">
				<anchored to="coins" width="20" height="20">
					<left anchor="right" offset="17" />
					<top anchor="center" offset="-60" />
				</anchored>
				<readonly />
				<gmvisibleonly />
			</basicnumber>
			<label_ps name="label_partyinventoryweight">
				<anchored to="partyinventoryweight" position="righthigh" offset="5,0" />
				<static>lb</static>
				<gmvisibleonly />
			</label_ps>
		</sheetdata>
	</windowclass>

	<windowclass name="ps_parcelitem" merge="join">
		<sheetdata>
			<basicstring name="name">
				<anchored position="insidetopleft" offset="45,2">
					<right parent="rightanchor" anchor="left" relation="current" offset="-40"/>
				</anchored>
				<multilinespacing>20</multilinespacing>
				<empty textres="library_recordtype_empty_item"/>
			</basicstring>
			<number_dropadd name="weight">
				<anchored height="20">
					<right parent="rightanchor" anchor="left" relation="current" offset="-10"/>
					<left parent="name" anchor="right" offset="10"/>
					<top parent="name" anchor="top" />
				</anchored>
				<hideonvalue>0</hideonvalue>
			</number_dropadd>
		</sheetdata>
	</windowclass>
</root>
