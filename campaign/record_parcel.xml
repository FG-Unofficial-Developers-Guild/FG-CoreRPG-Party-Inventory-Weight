<?xml version="1.0" encoding="iso-8859-1"?>

<!-- 
  Please see the LICENSE.md file included with this distribution for 
  attribution and copyright information.
-->

<root>
	<windowclass name="treasureparcel" merge="join">
		<script>
			local function updateWeight()
				local node_parcel = getDatabaseNode()
				local node_party_coins = node_parcel.getChild('coinlist')
				local node_party_items = node_parcel.getChild('itemlist')

				local number_weight = ParcelWeight.calculateItemWeight(node_party_items) + ParcelWeight.calculateCoinWeight(node_party_coins)
				DB.setValue(node_parcel, 'parcelweight', 'number', ParcelWeight.round(number_weight))
			end
			local function manageHandlers(bRemove)
				if bRemove then
					DB.removeHandler("treasureparcels.*.coinlist.*", "onChildUpdate", updateWeight)
					DB.removeHandler("treasureparcels.*.coinlist", "onChildDeleted", updateWeight)

					DB.removeHandler("treasureparcels.*.itemlist.*.count", "onUpdate", updateWeight)
					DB.removeHandler("treasureparcels.*.itemlist.*.weight", "onUpdate", updateWeight)
					DB.removeHandler("treasureparcels.*.itemlist", "onChildDeleted", updateWeight)
				else
					DB.addHandler("treasureparcels.*.coinlist.*", "onChildUpdate", updateWeight)
					DB.addHandler("treasureparcels.*.coinlist", "onChildDeleted", updateWeight)

					DB.addHandler("treasureparcels.*.itemlist.*.count", "onUpdate", updateWeight)
					DB.addHandler("treasureparcels.*.itemlist.*.weight", "onUpdate", updateWeight)
					DB.addHandler("treasureparcels.*.itemlist", "onChildDeleted", updateWeight)
				end
			end
			function onInit()
				if super and super.onInit then
					super.onInit()
				end
				if Session.IsHost then
					manageHandlers()
				end
				updateWeight()
			end
			function onClose()
				if super and super.onClose then
					super.onClose()
				end
				if Session.IsHost then
					manageHandlers(true)
				end
			end
		</script>
		<sheetdata>
			<frame_parcel name="coinframe">
				<anchored to="contentframe" width="165">
					<top />
					<left />
					<bottom offset="-30" />
				</anchored>
			</frame_parcel>

			<!-- Total weight -->
			<basicnumber name="parcelweight">
				<anchored to="contentframe" width="30" height="20">
					<left anchor="left" offset="-1" />
					<bottom anchor="bottom" offset="10" />
				</anchored>
				<readonly />
			</basicnumber>
			<!-- total weight label -->
			<label name="label_parcelweight">
				<anchored to="parcelweight" width="50" height="20">
					<left anchor="right" offset="5" />
					<bottom anchor="bottom" offset="0" />
				</anchored>
				<static textres="ref_label_listweight" />
			</label>

			<!--<basicnumber name="parcelvalue">
				<anchored to="coinframe" width="30" height="20">
					<right anchor="right" offset="1" />
					<bottom parent="parcelweight" anchor="bottom" />
				</anchored>
				<readonly />
				<gmvisibleonly />
			</basicnumber>
			<label name="label_parcelweight">
				<anchored to="parcelweight" width="50" height="20">
					<right anchor="left" offset="-5" />
					<bottom anchor="bottom" offset="0" />
				</anchored>
				<static textres="ref_label_cost" />
			</label> -->
		</sheetdata>
	</windowclass>
</root>
